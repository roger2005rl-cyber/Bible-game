<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>Bible Quiz Ultra ‚Äî Biggest Bible Game</title>
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#0f172a; --ink:#e5e7eb; --muted:#a1a1aa; --panel:#0b1224; --border:#ffffff22;
    --hi:#22d3ee; --hi2:#a78bfa; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    background:
      radial-gradient(1200px 800px at 10% -10%, #1e293b, transparent 60%),
      radial-gradient(1200px 600px at 110% 0%, #0ea5e9, transparent 40%),
      radial-gradient(900px 900px at 20% 120%, #8b5cf6, transparent 50%),
      var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
    display:flex;align-items:center;justify-content:center;padding:12px
  }
  .app{width:min(980px,100%);border:1px solid #ffffff16;border-radius:16px;background:linear-gradient(180deg,#ffffff0a,#00000014);backdrop-filter:blur(10px);box-shadow:0 20px 60px #0008;overflow:hidden}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;background:#0000002a;border-bottom:1px solid #ffffff12}
  .title{font-weight:900;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
  .chip{padding:6px 10px;border-radius:999px;background:#ffffff1a;color:var(--ink);font-size:14px}
  .chip.bad{background:#ef44441a;color:#fecaca}
  .chip.ok{background:#22c55e1a;color:#bbf7d0}
  .chip.hi{background:linear-gradient(90deg,var(--hi),var(--hi2)); color:#0b1020; font-weight:900}
  .wrap{padding:14px; display:grid; gap:14px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  @media (max-width:820px){.grid{grid-template-columns:1fr}}
  .pan{background:#0b1224aa;border:1px solid #ffffff12;border-radius:14px;padding:14px}
  .q{font-size:22px;line-height:1.35;font-weight:800;margin:6px 0 2px;min-height:52px;transition:opacity .25s}
  .answers{display:grid;gap:10px;margin-top:6px}
  button.answer{font:inherit;padding:14px 16px;text-align:left;border-radius:12px;border:1px solid var(--border);background:#ffffff12;color:var(--ink);cursor:pointer;transition:transform .08s, background .2s,border-color .2s;font-size:18px}
  button.answer:active{transform:scale(.98)}
  button.answer.correct{background:#22c55e2a;border-color:#22c55e66}
  button.answer.wrong{background:#ef444426;border-color:#ef444466}
  .foot{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:8px}
  .btn{font:inherit;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#ffffff12;color:var(--ink);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--hi),var(--hi2)); border:none;color:#0b1020;font-weight:900}
  .btn.warn{background:linear-gradient(90deg,#fde047,#fb923c); border:none;color:#0b1020;font-weight:900}
  .btn.danger{background:linear-gradient(90deg,#fb7185,#facc15); border:none;color:#0b1020;font-weight:900}
  .btn.ghost{background:transparent}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .row{display:flex;flex-wrap:wrap;gap:8px}
  .pill{padding:7px 10px;border-radius:999px;border:1px dashed #ffffff25;background:#ffffff10;cursor:pointer}
  .pill.active{outline:2px solid var(--hi)}
  .stat{display:flex;align-items:center;gap:6px}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#000000b3;border:1px solid #ffffff18;padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px #0007;z-index:50}
  .hide{display:none!important}
  .blink{animation:blink 1s infinite}
  @keyframes blink{50%{opacity:.25}}
  textarea, input[type="number"],input[type="text"]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #ffffff22;background:#0f172a;color:var(--ink)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #ffffff1a;padding:6px 8px;text-align:left}
  .badge{display:inline-block;margin:2px 4px;padding:6px 10px;border-radius:999px;background:#ffffff12;border:1px solid #ffffff22}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Bible Quiz Ultra">
  <div class="bar">
    <div class="title">üìò‚ö°Ô∏è <b>Bible Quiz Ultra</b></div>
    <div class="row">
      <span class="chip" id="chipLevel">Easy</span>
      <span class="chip" id="chipCat">All</span>
      <span class="chip" id="chipRound">Q 1/20</span>
      <span class="chip" id="chipScore">Score: 0</span>
      <span class="chip" id="chipLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
      <span class="chip bad" id="chipTimer">‚è±Ô∏è 30s</span>
      <span class="chip ok" id="chipStreak">Streak: 0</span>
      <span class="chip hi" id="chipHigh">High: 0</span>
    </div>
  </div>

  <div class="wrap grid">
    <!-- Left: Game -->
    <div class="pan">
      <div class="q" id="question">Set options and press ‚ÄúStart.‚Äù</div>
      <div class="answers" id="answers"></div>
      <div class="foot">
        <div class="row">
          <button class="btn" id="btn5050">üßØ 50/50</button>
          <button class="btn" id="btnSkip">‚è≠ Skip</button>
          <button class="btn" id="btnTime">‚è≤ +10s</button>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnTheme">üåô Theme</button>
          <button class="btn" id="btnPause">‚è∏ Pause</button>
          <button class="btn primary" id="btnStart">‚ñ∂Ô∏è Start</button>
        </div>
      </div>
    </div>

    <!-- Right: Options / Leaderboard / Editor -->
    <div class="pan">
      <h3 style="margin:0 0 8px 0">Options</h3>
      <div class="row" id="levels">
        <span class="pill active" data-level="Easy">Easy</span>
        <span class="pill" data-level="Medium">Medium</span>
        <span class="pill" data-level="Hard">Hard</span>
      </div>
      <div style="height:6px"></div>
      <div class="row" id="cats">
        <span class="pill active" data-cat="All">All</span>
        <span class="pill" data-cat="OT">OT</span>
        <span class="pill" data-cat="NT">NT</span>
        <span class="pill" data-cat="People">People</span>
        <span class="pill" data-cat="Miracles">Miracles</span>
        <span class="pill" data-cat="Places">Places</span>
      </div>
      <div style="height:6px"></div>
      <div class="row">
        <label class="stat">üßÆ # Questions: <input id="numQ" type="number" min="5" max="100" value="20" style="width:90px;margin-left:8px"></label>
        <label class="stat">‚è± /Q Seconds: <input id="secQ" type="number" min="8" max="60" value="30" style="width:90px;margin-left:8px"></label>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="stat"><input type="checkbox" id="chkLightning"> ‚ö° Lightning bonuses</label>
        <label class="stat"><input type="checkbox" id="chkSounds" checked> üîä Sounds</label>
      </div>

      <hr style="border-color:#ffffff1a">

      <h3 style="margin:0 0 8px 0">Leaderboard (local)</h3>
      <table id="board"><thead><tr><th>Level</th><th>Cat</th><th>Score</th><th>Date</th></tr></thead><tbody></tbody></table>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnResetHigh">Reset High</button>
        <button class="btn warn" id="btnClearBoard">Clear Leaderboard</button>
      </div>

      <hr style="border-color:#ffffff1a">
      <h3 style="margin:0 0 8px 0">Question Editor (add thousands!)</h3>
      <div class="row">
        <button class="btn" id="btnExport">‚¨áÔ∏è Export JSON</button>
        <label class="btn">‚¨ÜÔ∏è Import JSON <input type="file" id="fileImport" accept="application/json" style="display:none"></label>
        <button class="btn" id="btnAddSample">+ Add 5 Sample</button>
      </div>
      <textarea id="editor" rows="6" placeholder='Paste or type questions here as JSON array: [{"q":"","a":["","","",""],"c":0,"cat":"OT","d":"Easy"}]'></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="btnApply">‚úÖ Apply to Game</button>
      </div>
      <div style="margin-top:8px" id="achvArea"></div>
    </div>

    <!-- Results Panel -->
    <div class="pan hide" id="result">
      <div class="q">Results</div>
      <div id="resultBody"></div>
      <div class="foot">
        <button class="btn" id="btnShare">Share Score</button>
        <button class="btn primary" id="btnAgain">üîÑ Play Again</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================== Starter Question Pack (~100) ==================
   Each item: { q, a:[A,B,C,D], c:indexCorrect(0-3), cat:"OT|NT|People|Miracles|Places", d:"Easy|Medium|Hard" }
   You can import thousands via the in-app editor ‚Äî no code changes needed.
==================================================================== */
let PACK = [
  // --- Old Testament (Easy/Medium/Hard) ---
  {q:"Who built an ark to survive the flood?",a:["Moses","Noah","Abraham","David"],c:1,cat:"OT",d:"Easy"},
  {q:"Which sea did Moses (by God‚Äôs power) part?",a:["Red Sea","Dead Sea","Galilee","Mediterranean"],c:0,cat:"OT",d:"Easy"},
  {q:"Who interpreted dreams for Pharaoh?",a:["Joseph","Benjamin","Judah","Levi"],c:0,cat:"OT",d:"Easy"},
  {q:"Who killed Goliath?",a:["Saul","David","Samuel","Jonathan"],c:1,cat:"OT",d:"Easy"},
  {q:"‚ÄòThe Lord is my shepherd‚Äô is in:",a:["Psalm 1","Psalm 23","Psalm 119","Psalm 150"],c:1,cat:"OT",d:"Easy"},
  {q:"Who saw the burning bush?",a:["Elijah","Elisha","Moses","Aaron"],c:2,cat:"OT",d:"Easy"},
  {q:"Which city‚Äôs walls fell after trumpet blasts?",a:["Ai","Jericho","Nineveh","Babylon"],c:1,cat:"OT",d:"Medium"},
  {q:"Noah sent which bird first from the ark?",a:["Dove","Sparrow","Raven","Eagle"],c:2,cat:"OT",d:"Medium"},
  {q:"Abraham‚Äôs promised son was:",a:["Ishmael","Isaac","Esau","Jacob"],c:1,cat:"OT",d:"Medium"},
  {q:"Moses‚Äô sister was:",a:["Miriam","Deborah","Hannah","Ruth"],c:0,cat:"OT",d:"Medium"},
  {q:"Which queen visited Solomon to test his wisdom?",a:["Queen of Sheba","Candace","Jezebel","Athaliah"],c:0,cat:"OT",d:"Medium"},
  {q:"Who interpreted the handwriting on the wall?",a:["Daniel","Joseph","Ezra","Nehemiah"],c:0,cat:"OT",d:"Hard"},
  {q:"Who was thrown into the lions‚Äô den?",a:["Daniel","Ezekiel","Jeremiah","Nehemiah"],c:0,cat:"OT",d:"Medium"},
  {q:"Which woman became a pillar of salt?",a:["Lot‚Äôs wife","Naomi","Rahab","Leah"],c:0,cat:"OT",d:"Easy"},
  {q:"Who dreamed of a ladder reaching to heaven?",a:["Isaac","Jacob","Esau","Ishmael"],c:1,cat:"OT",d:"Medium"},
  {q:"What weapon did Samson famously use?",a:["Sword","Spear","Jawbone","Sling"],c:2,cat:"OT",d:"Medium"},
  {q:"First book of the Bible is:",a:["Exodus","Genesis","Leviticus","Numbers"],c:1,cat:"OT",d:"Easy"},
  {q:"How many plagues struck Egypt in Exodus?",a:["5","7","10","12"],c:2,cat:"OT",d:"Medium"},
  {q:"Who was the first king of Israel?",a:["Saul","David","Solomon","Samuel"],c:0,cat:"OT",d:"Medium"},
  {q:"Which prophet saw a valley of dry bones live?",a:["Isaiah","Jeremiah","Ezekiel","Daniel"],c:2,cat:"OT",d:"Hard"},
  {q:"‚ÄòIn the beginning‚Ä¶‚Äô starts which book?",a:["Genesis","Exodus","Job","Psalms"],c:0,cat:"OT",d:"Easy"},
  {q:"Who wrote many of the Psalms?",a:["Moses","David","Solomon","Asaph"],c:1,cat:"OT",d:"Easy"},

  // --- New Testament ---
  {q:"Where was Jesus born?",a:["Nazareth","Bethlehem","Jerusalem","Capernaum"],c:1,cat:"NT",d:"Easy"},
  {q:"Who baptized Jesus?",a:["John the Baptist","Peter","Paul","James"],c:0,cat:"NT",d:"Easy"},
  {q:"Which apostle denied Jesus three times?",a:["John","Peter","Andrew","Philip"],c:1,cat:"NT",d:"Easy"},
  {q:"Shortest verse ‚ÄòJesus wept‚Äô is:",a:["John 11:35","Luke 1:1","Mark 5:5","Matt 5:5"],c:0,cat:"NT",d:"Easy"},
  {q:"What happened at Pentecost?",a:["Jesus ascended","Holy Spirit came","Temple fell","Rapture"],c:1,cat:"NT",d:"Medium"},
  {q:"Paul‚Äôs original name was:",a:["Saul","Silas","Simeon","Stephen"],c:0,cat:"NT",d:"Easy"},
  {q:"Where did Saul encounter Jesus?",a:["Damascus road","Jerusalem","Antioch","Rome"],c:0,cat:"NT",d:"Medium"},
  {q:"Which Gospel is longest?",a:["Matthew","Mark","Luke","John"],c:2,cat:"NT",d:"Medium"},
  {q:"Armor of God appears in:",a:["Ephesians 6","Romans 8","Galatians 5","Hebrews 11"],c:0,cat:"NT",d:"Medium"},
  {q:"The Prodigal Son is found in:",a:["Matthew","Mark","Luke","John"],c:2,cat:"NT",d:"Medium"},
  {q:"‚ÄòGod with us‚Äô translates which name?",a:["Emmanuel","Messiah","Rabboni","Maranatha"],c:0,cat:"NT",d:"Medium"},
  {q:"Where did Jesus pray before His arrest?",a:["Nazareth","Gethsemane","Bethany","Jordan"],c:1,cat:"NT",d:"Medium"},
  {q:"How many disciples did Jesus choose?",a:["10","11","12","13"],c:2,cat:"NT",d:"Easy"},
  {q:"Which letter contains the ‚Äòlove chapter‚Äô?",a:["1 Corinthians 13","Romans 12","Hebrews 11","James 1"],c:0,cat:"NT",d:"Medium"},
  {q:"Last book of the Bible is:",a:["Revelation","Acts","Hebrews","Romans"],c:0,cat:"NT",d:"Easy"},
  {q:"Who wrote most New Testament letters?",a:["Peter","Paul","John","Luke"],c:1,cat:"NT",d:"Medium"},

  // --- People ---
  {q:"Who climbed a sycamore tree to see Jesus?",a:["Peter","Zacchaeus","Matthew","Paul"],c:1,cat:"People",d:"Easy"},
  {q:"Who anointed Jesus‚Äô feet with perfume?",a:["Mary of Bethany","Martha","Salome","Priscilla"],c:0,cat:"People",d:"Medium"},
  {q:"Who was the Roman governor at Jesus‚Äô trial?",a:["Pilate","Herod","Felix","Festus"],c:0,cat:"People",d:"Medium"},
  {q:"Who is called the ‚Äòfriend of God‚Äô?",a:["Abraham","Moses","David","Enoch"],c:0,cat:"People",d:"Hard"},
  {q:"Who walked on water with Jesus briefly?",a:["Peter","James","John","Thomas"],c:0,cat:"People",d:"Medium"},
  {q:"Who was the tax collector among the apostles?",a:["Peter","Matthew","Bartholomew","Thomas"],c:1,cat:"People",d:"Medium"},
  {q:"Who betrayed Jesus?",a:["Peter","Judas Iscariot","Thomas","James"],c:1,cat:"People",d:"Easy"},
  {q:"Who was thrown into a fiery furnace?",a:["Daniel","Shadrach, Meshach & Abednego","Joseph","Elijah"],c:1,cat:"People",d:"Medium"},
  {q:"Who was the mother of Jesus?",a:["Elizabeth","Mary","Martha","Sarah"],c:1,cat:"People",d:"Easy"},

  // --- Miracles ---
  {q:"Jesus‚Äô first recorded miracle took place in:",a:["Cana","Bethany","Jericho","Bethlehem"],c:0,cat:"Miracles",d:"Easy"},
  {q:"At Cana, Jesus turned water into:",a:["Oil","Wine","Milk","Juice"],c:1,cat:"Miracles",d:"Easy"},
  {q:"Jesus fed about 5,000 with loaves and:",a:["Dates","Figs","Fish","Grapes"],c:2,cat:"Miracles",d:"Medium"},
  {q:"Who was raised from the dead by Jesus in John 11?",a:["Jairus","Lazarus","Tabitha","Widow‚Äôs son"],c:1,cat:"Miracles",d:"Medium"},
  {q:"Which prophet called down fire on Mount Carmel?",a:["Elisha","Elijah","Isaiah","Jeremiah"],c:1,cat:"Miracles",d:"Medium"},
  {q:"Which river healed Naaman when he dipped seven times?",a:["Jordan","Nile","Euphrates","Tigris"],c:0,cat:"Miracles",d:"Medium"},
  {q:"What fell from heaven to feed Israel in the wilderness?",a:["Quail","Manna","Dates","Corn"],c:1,cat:"Miracles",d:"Easy"},

  // --- Places ---
  {q:"Where was Jesus raised (grew up)?",a:["Bethlehem","Nazareth","Jerusalem","Capernaum"],c:1,cat:"Places",d:"Easy"},
  {q:"Where did the Spirit descend at Pentecost?",a:["Jerusalem","Antioch","Rome","Damascus"],c:0,cat:"Places",d:"Medium"},
  {q:"Which city is associated with Jericho‚Äôs walls?",a:["Judah","Samaria","Jericho","Tyre"],c:2,cat:"Places",d:"Easy"},
  {q:"Where did David reign as king (capital)?",a:["Hebron","Jerusalem","Shiloh","Bethel"],c:1,cat:"Places",d:"Medium"},
  {q:"Where did Elijah confront Baal‚Äôs prophets?",a:["Mount Sinai","Mount Carmel","Mount of Olives","Mount Tabor"],c:1,cat:"Places",d:"Medium"},
  {q:"On which road did Saul meet Jesus?",a:["Emmaus road","Jericho road","Damascus road","Gaza road"],c:2,cat:"Places",d:"Medium"}
];

// ======= Helpers =======
const el = s => document.querySelector(s);
const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
const sample = (arr,n) => shuffle([...arr]).slice(0,n);

// ======= State =======
let state = {
  level:'Easy', cat:'All', n:20, secs:30,
  qIdx:0, streak:0, score:0, lives:3, timer:30, running:false,
  lightning:false, used5050:false, usedSkip:false, usedTime:false,
  high:0, set:[] // current question set
};

// ======= Audio (WebAudio) =======
let audioOK = true;
const ctx = new (window.AudioContext||window.webkitAudioContext)();
function tone(f=880, d=0.12, type='sine', g=0.05){
  if(!audioOK) return;
  const o=ctx.createOscillator(), gn=ctx.createGain();
  o.type=type; o.frequency.value=f; gn.gain.value=g;
  o.connect(gn); gn.connect(ctx.destination); o.start();
  setTimeout(()=>{o.stop(); o.disconnect(); gn.disconnect();}, d*1000);
}
const sRight=()=>{ tone(880,0.08,'triangle',0.06); setTimeout(()=>tone(1320,0.08,'triangle',0.05),90); };
const sWrong=()=>{ tone(220,0.14,'sawtooth',0.06); setTimeout(()=>tone(160,0.12,'sawtooth',0.05),120); };
const sTick =()=>{ tone(1200,0.04,'square',0.02); };

// ======= HUD =======
function loadHigh(){ state.high = Number(localStorage.getItem(keyHigh())||0); }
function saveHigh(){ if(state.score>state.high){ localStorage.setItem(keyHigh(), String(state.score)); state.high = state.score; } }
const keyHigh = ()=>`bqultra_high_${state.level}_${state.cat}`;

function updateHud(){
  el('#chipLevel').textContent = state.level + (state.lightning?' ‚ö°':'');
  el('#chipCat').textContent = state.cat;
  el('#chipRound').textContent = `Q ${Math.min(state.qIdx+1, state.set.length)}/${state.set.length}`;
  el('#chipScore').textContent = `Score: ${state.score}`;
  el('#chipLives').textContent = '‚ù§Ô∏è'.repeat(state.lives)+'üñ§'.repeat(3-state.lives);
  el('#chipTimer').textContent = `‚è±Ô∏è ${state.timer}s`;
  el('#chipTimer').classList.toggle('blink', state.timer<=5);
  el('#chipStreak').textContent = `Streak: ${state.streak}`;
  el('#chipHigh').textContent = `High: ${state.high}`;
}

// ======= Build Question Set =======
function buildSet(){
  let pool = PACK.filter(q => (state.cat==='All'||q.cat===state.cat) && (q.d===state.level));
  // If pool small (because we ship starter pack), broaden difficulty slightly:
  if(pool.length < state.n){ pool = PACK.filter(q => (state.cat==='All'||q.cat===state.cat)); }
  state.set = sample(pool, Math.min(state.n, pool.length));
  state.qIdx=0; state.streak=0; state.score=0; state.lives=3;
  state.used5050 = state.usedSkip = state.usedTime = false;
}

// ======= Timer =======
let tHandle=null;
function startTimer(){
  if(state.running) return;
  state.running = true;
  state.timer = state.secs;
  tick();
}
function pauseTimer(){ state.running=false; clearTimeout(tHandle); }
function tick(){
  if(!state.running) return;
  state.timer--; updateHud();
  if(state.timer<=5 && state.timer>0) sTick();
  if(state.timer<=0){ handleWrong("time"); return; }
  tHandle = setTimeout(tick, 1000);
}

// ======= Render =======
function currentQ(){ return state.set[state.qIdx]; }
function drawQuestion(){
  const q=currentQ();
  const qBox=el('#question'), aBox=el('#answers');
  if(!q){ return showResults(); }
  qBox.style.opacity=0;
  setTimeout(()=>{ qBox.textContent = q.q; qBox.style.opacity=1; },120);
  aBox.innerHTML='';
  q.a.forEach((txt,i)=>{
    const b=document.createElement('button');
    b.className='answer'; b.innerHTML = `<b>${'ABCD'[i]}.</b> ${txt}`;
    b.onclick=()=>choose(i,b);
    aBox.appendChild(b);
  });
}

function disableAnswers(){ document.querySelectorAll('button.answer').forEach(b=>b.disabled=true); }

// ======= Choose =======
function choose(i, btn){
  disableAnswers();
  const q=currentQ();
  if(i===q.c){
    state.streak++;
    let add = 10 + Math.min(20, state.streak*2); // combo bonus
    if(state.lightning) add += 10;
    state.score += add;
    btn.classList.add('correct'); sRight();
    toast(`‚úÖ Correct! +${add} (streak x${state.streak})`,'ok');
  }else{
    handleWrong("miss", btn);
    return;
  }
  updateHud();
  next();
}
function handleWrong(reason="miss", btn=null){
  state.streak=0; state.lives--;
  if(btn) btn.classList.add('wrong');
  sWrong();
  toast(reason==="time"?'‚è±Ô∏è Time up! -1 life':'‚ùå Oops! -1 life', 'bad');
  updateHud();
  if(state.lives<=0) return showResults();
  next();
}

function next(){
  pauseTimer();
  setTimeout(()=>{
    state.qIdx++;
    if(state.qIdx>=state.set.length){ showResults(); return; }
    state.timer = state.secs;
    drawQuestion(); startTimer();
  }, 320);
}

// ======= Results & Leaderboard =======
function showResults(){
  pauseTimer();
  saveHigh();
  const body = el('#resultBody');
  const date = new Date().toLocaleString();
  // add to leaderboard list
  const rec = {lvl:state.level, cat:state.cat, score:state.score, date};
  const list = JSON.parse(localStorage.getItem('bqultra_board')||'[]');
  list.unshift(rec); localStorage.setItem('bqultra_board', JSON.stringify(list.slice(0,50)));
  renderBoard();

  body.innerHTML = `
    <p><b>Level:</b> ${state.level}</p>
    <p><b>Category:</b> ${state.cat}</p>
    <p><b>Score:</b> ${state.score}</p>
    <p><b>High Score (this mode):</b> ${state.high}</p>
    <div style="margin-top:8px">${achievementBadges(state.score, state.level).join('')}</div>
  `;
  el('#result').classList.remove('hide');
}

function renderBoard(){
  const tb = el('#board tbody'); tb.innerHTML='';
  const list = JSON.parse(localStorage.getItem('bqultra_board')||'[]');
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.lvl}</td><td>${r.cat}</td><td>${r.score}</td><td>${r.date}</td>`;
    tb.appendChild(tr);
  });
}

// ======= Lifelines =======
el('#btn5050').onclick=()=>{
  if(state.used5050) return toast('50/50 already used this run','bad');
  const q=currentQ(); if(!q) return;
  const wrongs=[0,1,2,3].filter(i=>i!==q.c);
  const kill = sample(wrongs,2);
  document.querySelectorAll('button.answer').forEach((b,i)=>{ if(kill.includes(i)) { b.disabled=true; b.style.opacity=.4; } });
  state.used5050=true; toast('Removed two wrong options','ok'); sTick();
};
el('#btnSkip').onclick=()=>{
  if(state.usedSkip) return toast('Skip already used','bad');
  state.usedSkip=true; toast('Question skipped','ok'); sTick();
  next();
};
el('#btnTime').onclick=()=>{
  if(state.usedTime) return toast('Time boost already used','bad');
  state.usedTime=true; state.timer = Math.min(60, state.timer+10); updateHud(); sTick();
  toast('+10 seconds added','ok');
};

// ======= Theme & Controls =======
let dark=true;
el('#btnTheme').onclick=()=>{ dark=!dark; document.documentElement.style.filter = dark ? 'none' : 'invert(1) hue-rotate(180deg)'; };

el('#btnStart').onclick=()=>{
  el('#result').classList.add('hide');
  state.n = clampNum(el('#numQ').value,5,100);
  state.secs = clampNum(el('#secQ').value,8,60);
  state.lightning = el('#chkLightning').checked;
  audioOK = el('#chkSounds').checked;
  buildSet(); loadHigh(); updateHud(); drawQuestion(); startTimer();
};
el('#btnPause').onclick=()=>pauseTimer();
el('#btnAgain').onclick=()=>{ el('#result').classList.add('hide'); buildSet(); loadHigh(); updateHud(); drawQuestion(); startTimer(); };
el('#btnShare').onclick=async()=>{
  const text=`I scored ${state.score} on Bible Quiz Ultra (${state.level}/${state.cat})!`;
  if(navigator.share){ try{ await navigator.share({title:'Bible Quiz Ultra', text}); }catch{} }
  else { try{ await navigator.clipboard.writeText(text); toast('Score copied!','ok'); }catch{} }
};
el('#btnResetHigh').onclick=()=>{ localStorage.removeItem(keyHigh()); loadHigh(); updateHud(); toast('High score reset','ok'); };
el('#btnClearBoard').onclick=()=>{ localStorage.removeItem('bqultra_board'); renderBoard(); toast('Leaderboard cleared','ok'); };

// Options: levels & categories
document.querySelectorAll('#levels .pill').forEach(p=>p.onclick=()=>{
  document.querySelectorAll('#levels .pill').forEach(x=>x.classList.remove('active'));
  p.classList.add('active'); state.level = p.dataset.level; el('#chipLevel').textContent=state.level; loadHigh(); updateHud();
});
document.querySelectorAll('#cats .pill').forEach(p=>p.onclick=()=>{
  document.querySelectorAll('#cats .pill').forEach(x=>x.classList.remove('active'));
  p.classList.add('active'); state.cat = p.dataset.cat; el('#chipCat').textContent=state.cat;
});

// ======= Editor / Import / Export =======
function packToJSON(){ return JSON.stringify(PACK, null, 2); }
function jsonToPack(txt){ const arr = JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON root must be an array'); return arr; }
el('#btnExport').onclick=()=>{
  const blob = new Blob([packToJSON()], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'bible-quiz-pack.json'}); a.click();
  URL.revokeObjectURL(url);
  toast('Exported current questions as JSON','ok');
};
el('#fileImport').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{
    const arr = jsonToPack(txt);
    // Validate minimal fields
    for(const q of arr){
      if(!q.q || !Array.isArray(q.a) || typeof q.c!=='number') throw new Error('Invalid question format');
      if(!q.cat) q.cat='OT'; if(!q.d) q.d='Easy';
    }
    PACK = arr; el('#editor').value = JSON.stringify(arr.slice(0,5),null,2)+'\n... loaded '+arr.length+' total';
    toast(`Imported ${arr.length} questions ‚úÖ`,'ok');
  }catch(e){ toast('Import error: '+e.message,'bad'); }
});
el('#btnApply').onclick=()=>{
  try{
    const txt = el('#editor').value.trim();
    if(!txt) return toast('Editor is empty','bad');
    const arr = jsonToPack(txt);
    for(const q of arr){
      if(!q.q || !Array.isArray(q.a) || q.a.length!==4 || typeof q.c!=='number') throw new Error('Each item needs q,a[4],c');
      if(!q.cat) q.cat='OT'; if(!q.d) q.d='Easy';
    }
    PACK = [...PACK, ...arr];
    toast(`Added ${arr.length} questions to the pack üéâ`,'ok');
  }catch(e){ toast('Editor error: '+e.message,'bad'); }
};
el('#btnAddSample').onclick=()=>{
  const samples = [
    {q:"Which prophet confronted King Ahab?",a:["Elisha","Elijah","Isaiah","Micah"],c:1,cat:"OT",d:"Medium"},
    {q:"Where did Jesus calm the storm?",a:["Jordan","Sea of Galilee","Nile","Mediterranean"],c:1,cat:"Miracles",d:"Easy"},
    {q:"Who wrote the Book of Revelation?",a:["Peter","Paul","John","James"],c:2,cat:"NT",d:"Medium"},
    {q:"Who interpreted dreams in Babylon?",a:["Nehemiah","Daniel","Ezra","Zerubbabel"],c:1,cat:"OT",d:"Hard"},
    {q:"Where did Elijah flee and hear a gentle whisper?",a:["Sinai","Horeb","Carmel","Moriah"],c:1,cat:"Places",d:"Hard"}
  ];
  el('#editor').value = JSON.stringify(samples, null, 2);
  toast('Loaded 5 sample items into editor','ok');
};

// ======= Achievements =======
function achievementBadges(score, level){
  const out=[];
  if(score>=150) out.push(badge('üî• On Fire (150+)'));
  if(score>=250) out.push(badge('‚ö° Lightning Master (250+)'));
  if(level==='Hard' && score>=200) out.push(badge('üéØ Hard Hero (200+)'));
  if(state.streak>=5) out.push(badge('üèÜ Streak 5+'));
  if(!out.length) out.push(badge('‚ú® Keep Going!'));
  el('#achvArea').innerHTML = out.join('');
  return out;
}
function badge(txt){ return `<span class="badge">${txt}</span>`; }

// ======= Utils & Toast =======
function clampNum(v,min,max){ v=Number(v||0); if(isNaN(v)) v=min; return Math.max(min, Math.min(max, v)); }
function toast(msg, kind){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  if(kind==='bad') t.style.borderColor='#ef444466';
  if(kind==='ok') t.style.borderColor='#22c55e66';
  document.body.appendChild(t); setTimeout(()=>t.remove(), 1400);
}

// ======= Init =======
renderBoard(); loadHigh(); updateHud(); drawQuestion();
</script>
</body>
</html>
